# -*- coding: utf-8 -*-
"""
This module allows you to share items, to import files and to open URLs.
"""

from rubicon.objc import *

import pyto
import mainthread
import threading
__PySharingHelper__ = pyto.PySharingHelper

def shareItems(items):
    raise NameError("`shareItems` was renamed to `share_items`")

def pickDocumentsWithFilePicker(items):
    raise NameError("`pickDocumentsWithFilePicker` was renamed to `pick_documents`")

def pickedFiles():
    raise NameError("`pickedFiles` was renamed to `picked_files`")

def openURL(url):
    raise NameError("`openURL` was renamed to `open_url`")

def share_items(items):
    """
    Opens a share sheet with given items.
        
    Args:
        items: Items to be shared with the sheet.
    """
    
    __PySharingHelper__.share(items)

def quick_look(path):
    """
    Previews given file.
        
    This function doesn't block the current thread. You can call this function multiple times and the file path will be appended to the current Preview controller. Thread safe.
        
    Args:
        path: Path to preview.
    """
    
    try:
        pyto.QuickLookHelper.previewFile(path, script=threading.current_thread().script_path)
    except:
        pyto.QuickLookHelper.previewFile(path, script=None)

# MARK: - File picker

class __FilePicker__:
    """
    A class representing a file picker. On iOS, presents an `UIDocumentPickerViewController` and an `NSOpenPanel` on macOS.
    """

    fileTypes = []
    """
    Document types that can be opened.
    """
    
    allowsMultipleSelection = False
    """
    Allow multiple selection or not.
    """
    
    completion = None
    """
    The code to execute when files where picked.
    """
    
    urls = []
    """
    Picked URLs.
    """

    def __objcFilePicker__(self):
        filePicker = pyto.FilePicker.new()
        filePicker.fileTypes = self.fileTypes
        filePicker.allowsMultipleSelection = self.allowsMultipleSelection
        filePicker.completion = self.completion
    
        return filePicker
    
    @staticmethod
    def new():
        """
        Returns a new file picker.
        
        Should not be used, you can initialize an object by calling `__init__`, this function exists because this class was written in Objective-C.
        """
        
        return __FilePicker__()

FilePicker = __FilePicker__
"""
A class representing a file picker.
    
Example:
    filePicker = sharing.FilePicker()
    filePicker.fileTypes = ["public.data"]
    filePicker.allowsMultipleSelection = True
    
    def filesPicked() -> None:
        files = sharing.pickedFiles()
        sharing.share_items(files)
    
    filePicker.completion = filesPicked
    sharing.pick_documents(filePicker)
"""

def pick_documents(filePicker):
    """
    Pick documents with given parameters as a `FilePicker`.
        
    Args:
        filePicker: The parameters of the file picker to be presented.
    """
    
    __PySharingHelper__.presentFilePicker(filePicker.__objcFilePicker__())

def picked_files():
    """
    Returns files picked with `pickDocumentsWithFilePicker` as URLs.
    """
    
    return pyto.FilePicker.urls

# MARK: - URLs

__NSURL__ = ObjCClass("NSURL")
__UIApplication__ = ObjCClass("UIApplication")

def open_url(url):
    """
    Opens the given URL.
    
    Args:
        url: URL to open. Can be a String or an Objective-C `NSURL`.
    """
    
    __url__ = None
    
    def __openURL__() -> None:
        __UIApplication__.sharedApplication.openURL(__url__)
    
    if (type(url) is str):
        __url__ = __NSURL__.URLWithString(url)
        mainthread.run_sync(__openURL__)
    elif (__PySharingHelper__.isURL(url)):
        __url__ = url
        mainthread.run_sync(__openURL__)
    else:
        raise ValueError('url musts be a String or an Objective-C `NSURL`.')

