try:
    from pyto import ConsoleViewController
except:
    pass
import jedi
import sys
import traceback

def suggestForCode(code, index, path):
    
    for console in ConsoleViewController.objcVisibles:
        def visibleEditor():
            return console.editorSplitViewController.editor
    
        if visibleEditor().document.fileURL.path != path:
            continue
    
        if code.endswith(");\n"):
            if visibleEditor() is None:
                return
        
            visibleEditor().completions = []
            visibleEditor().suggestions = []
            visibleEditor().docStrings = None
            return
    
        try:
            script = jedi.Script(code, path=path)
        
            suggestions = []
            completions = []

            docs = {}

            line = 1
            column = 0

            for i in range(index):
                char = code[i]
                if char == "\n":
                    line += 1
                    column = 0
                else:
                    column += 1

            _completions = script.complete(line, column)
            for completion in _completions:
                suggestion = completion.name
                
                if (completion.complete.startswith(".")):
                    suggestion = "."+suggestion
            
                if completion.name in __builtins__["deprecated"]:
                    continue
            
                complete = completion.complete
                if complete.endswith("="):
                    complete = complete[:-1]

                suggestions.append(suggestion)
                completions.append(complete)

                '''if not ((completion.type == "function") and complete == ""):
                    

                if (completion.type == "function") and complete == "":
                    suggestions.append(suggestion+"(")
                    completions.append(complete+"(")
                    docs[suggestion+"("] = ""'''
            
                docs[suggestion] = ""
                        
            visibleEditor().completions = completions
            visibleEditor().suggestions = suggestions
            visibleEditor().docStrings = docs
        except Exception as e:
    
            sys.__stdout__.write("Code completion:\n "+traceback.format_exc()+"\n")
        
            if visibleEditor() is None:
                return

            visibleEditor().completions = []
            visibleEditor().suggestions = []
            visibleEditor().signature = ""
            visibleEditor().docStrings = None

def suggestionsForCode(code, path=None):
    
    try:
        if path is None:
            script = jedi.Script(code, len(code.splitlines()), len(code.splitlines()[-1])-1)
        else:
            script = jedi.Script(code, len(code.splitlines()), len(code.splitlines()[-1])-1, path)
        
        suggestions = {}
        
        for completion in script.completions():
            
            if (completion.complete.startswith(".")):
                suggestion = "."+suggestion
            
            if (completion.name.startswith("_") or completion.name in __builtins__["deprecated"]):
                continue

            suggestions[completion.name] = completion.complete
    
        return suggestions
    except Exception as e:
        return {}
