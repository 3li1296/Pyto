try:
    from pyto import ConsoleViewController
except:
    pass
import jedi
import sys
import traceback

jedi.settings.add_bracket_after_function = True

def suggestForCode(code, path):
    
    for console in ConsoleViewController.visibles:
        def visibleEditor():
            return console.editorSplitViewController.editor
    
        if visibleEditor().document.fileURL.path != path:
            continue
    
        if code[:-1].endswith(")"):
            if visibleEditor() is None:
                return
        
            visibleEditor().completions = []
            visibleEditor().suggestions = []
            visibleEditor().docStrings = None
            return
    
        try:
            script = jedi.Script(code, len(code.splitlines()), len(code.splitlines()[-1])-1, path)
        
            suggestions = []
            completions = []

            docs = {}
        
            for completion in script.completions():
                suggestion = completion.name
                
                if (completion.complete.startswith(".")):
                    suggestion = "."+suggestion
            
                if completion.name in __builtins__["deprecated"]:
                    continue
            
                complete = completion.complete
                if complete.endswith("="):
                    complete = complete[:-1]

                if not ((completion.type == "function") and complete == ""):
                    suggestions.append(suggestion)
                    completions.append(complete)

                docString = completion.docstring()

                if (completion.type == "module"):
                    docString = ""
                    
                if (completion.type == "function") and complete == "":
                    suggestions.append(suggestion+"(")
                    completions.append(complete+"(")
                    docs[suggestion+"("] = docString
            
                docString = (completion.name+"\n"+completion.type)+"\n\n"+docString
                docs[suggestion] = docString
            
            visibleEditor().completions = completions
            visibleEditor().suggestions = suggestions
            visibleEditor().docStrings = docs
        except Exception as e:
    
            sys.__stdout__.write("Code completion:\n "+traceback.format_exc()+"\n")
        
            if visibleEditor() is None:
                return

            visibleEditor().completions = []
            visibleEditor().suggestions = []
            visibleEditor().docStrings = None

def suggestionsForCode(code, path=None):
    
    try:
        if path is None:
            script = jedi.Script(code, len(code.splitlines()), len(code.splitlines()[-1])-1)
        else:
            script = jedi.Script(code, len(code.splitlines()), len(code.splitlines()[-1])-1, path)
        
        suggestions = {}
        
        for completion in script.completions():
            
            if (completion.complete.startswith(".")):
                suggestion = "."+suggestion
            
            if (completion.name.startswith("_") or completion.name in __builtins__["deprecated"]):
                continue

            suggestions[completion.name] = completion.complete
    
        return suggestions
    except Exception as e:
        return {}
