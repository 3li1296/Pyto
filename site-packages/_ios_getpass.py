import sys
import time

from pyto import PyInputHelper
from console import ignoredThreads
import threading
import os
try:
    from rubicon.objc import *
except ValueError:
    def ObjCClass(class_name):
        return None


if "widget" in os.environ:
    raise ImportError("Cannot ask for input from a widget")

def getpass(prompt=None, stream=sys.stdout):
    NSBundle = ObjCClass("NSBundle")
    if NSBundle.mainBundle.bundlePath.pathExtension == "appex":
        return None
    
    if prompt is None:
        prompt = ""
        
    print(prompt, end="")
    
    try:
        path = threading.current_thread().script_path
    except AttributeError:
        path = ""
    
    PyInputHelper.userInput.removeObjectForKey(path)
    
    try:
        PyInputHelper.getPassWithPrompt(prompt, script=threading.current_thread().script_path)
    except AttributeError:
        PyInputHelper.getPassWithPrompt(prompt, script=None)
    
    
    while path not in PyInputHelper.userInput or threading.currentThread() in ignoredThreads:
        time.sleep(0.2)
    
    userInput = PyInputHelper.getUserInput(path)
    PyInputHelper.userInput.removeObjectForKey(path)
    
    time.sleep(0.2)
    
    return str(userInput)
